# D√©finition des chemins
$ClamWinPath = "C:\Program Files (x86)\ClamWin\bin\clamscan.exe"
$DatabasePath = "C:\ProgramData\.clamwin\db"
$DossierReception = "\\serveur\samba_share"
$DossierAnalyse = "C:\analyse"
$DossierTransfer = "\\serveur\samba_sortie"
$FichierLog = "C:\log\logs.txt"

# Fonction d'√©criture dans le log
function Write-Log {
    param ($Message)
    "$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss")) | $Message" | Out-File -Append -FilePath $FichierLog
}

# V√©rification de la base ClamWin
if (!(Test-Path $DatabasePath)) {
    Write-Log "‚ö† Base ClamWin non trouv√©e. V√©rifiez l'installation ou mettez √† jour avec freshclam."
    exit
}

# V√©rification d'acc√®s au dossier de r√©ception
if (!(Test-Path $DossierReception)) {
    Write-Log "‚ùå Dossier de r√©ception inaccessible: $DossierReception"
    Write-Host "Dossier de r√©ception inaccessible. V√©rifiez l'acc√®s r√©seau."
    exit
}

# Surveillance des fichiers
while ($true) {
    Write-Log "üîÑ V√©rification des fichiers dans $DossierReception"

    # Attente avant de scanner les r√©pertoires, permet √† la connexion r√©seau de se stabiliser
    Start-Sleep -Seconds 5

    # V√©rification des r√©pertoires dans le dossier de r√©ception
    Get-ChildItem -Path $DossierReception -Directory | ForEach-Object {
        $DossierUtilisateur = $_.FullName

        # V√©rification si le dossier utilisateur existe
        if (!(Test-Path $DossierUtilisateur)) {
            Write-Log "‚ùå Dossier utilisateur non trouv√©: $DossierUtilisateur"
            return
        }

        Get-ChildItem -Path $DossierUtilisateur -Directory | ForEach-Object {
            $DossierFichier = $_.FullName
            Write-Log "üìÇ Dossier d√©tect√©: $DossierFichier"

            # D√©placement vers le dossier d'analyse
            $NomUtilisateur = (Get-Item $DossierUtilisateur).Name
            $DossierTemp = "$DossierAnalyse\$NomUtilisateur"
            if (!(Test-Path $DossierTemp)) {
                Write-Log "üìÇ Cr√©ation du dossier d'analyse: $DossierTemp"
                New-Item -Path $DossierTemp -ItemType Directory | Out-Null
            }

            # V√©rification que le fichier existe avant le d√©placement
            if (Test-Path $DossierFichier) {
                Write-Log "‚úÖ D√©placement du fichier vers $DossierTemp"
                Move-Item -Path $DossierFichier -Destination $DossierTemp -Force
                $DossierFichier = "$DossierTemp\$(Get-Item $DossierFichier).Name"
            } else {
                Write-Log "‚ùå Fichier non trouv√©: $DossierFichier"
                Write-Host "Fichier non trouv√©: $DossierFichier"
                return
            }

            # Analyse avec ClamWin
            if (Test-Path $DossierFichier) {
                Write-Log "üîç Analyse de $DossierFichier avec ClamWin"
                $Resultat = & "$ClamWinPath" --no-summary --infected --database="$DatabasePath" --log="$FichierLog" "$DossierFichier"

                # V√©rification du r√©sultat de l'analyse
                if ($Resultat -match "Infected files: 0") {
                    # Fichier sain : d√©placement vers le dossier de transfert
                    $DossierTransfertUtilisateur = "$DossierTransfer\$NomUtilisateur"
                    if (!(Test-Path $DossierTransfertUtilisateur)) {
                        Write-Log "üìÇ Cr√©ation du dossier de transfert: $DossierTransfertUtilisateur"
                        New-Item -Path $DossierTransfertUtilisateur -ItemType Directory | Out-Null
                    }
                    Move-Item -Path $DossierFichier -Destination $DossierTransfertUtilisateur -Force
                    Write-Log "‚úÖ $DossierFichier | sain | fichier_transfere"
                    Write-Host "R√©ussite: $DossierFichier transf√©r√© vers $DossierTransfertUtilisateur"
                } else {
                    Write-Log "‚ùå $DossierFichier | VIRUS | fichier_non_transfere"
                    Write-Host "√âchec: $DossierFichier est infect√© et n'a pas √©t√© transf√©r√©."
                }
            } else {
                Write-Log "‚ùå Fichier non trouv√© apr√®s le d√©placement: $DossierFichier"
            }

            Write-Log "üìå Analyse termin√©e pour $DossierFichier"
        }
    }
    Start-Sleep -Seconds 10
}

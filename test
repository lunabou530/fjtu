# Chemins des dossiers
$dossier_reception = "Z:\"
$dossier_analyse = "C:\projet\analyse"
$dossier_transfert = "C:\projet\disponible"
$dossier_quarantaine = "C:\projet\quarantaine"
$fichier_log = "C:\projet\logs\logs.txt"

# Chemin de ClamWin et de sa base de données
$clamwin_path = "C:\Program Files (x86)\ClamWin\bin\clamscan.exe"
$database_path = "C:\ProgramData\.clamwin\db"

# Fonction d'écriture dans le log
function Write-Log {
    param ($message)
    "$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss")) | $message" | Out-File -Append -FilePath $fichier_log
}

# Vérification de la base ClamWin
if (!(Test-Path $database_path)) {
    Write-Log "Base ClamWin non trouvée. Vérifiez l'installation ou mettez à jour avec freshclam."
    exit
}

# Création des dossiers s'ils n'existent pas
foreach ($dossier in @($dossier_analyse, $dossier_transfert, $dossier_quarantaine)) {
    if (!(Test-Path $dossier)) {
        New-Item -Path $dossier -ItemType Directory | Out-Null
    }
}

# Surveillance des fichiers
while ($true) {
    Get-ChildItem -Path $dossier_reception -Directory | ForEach-Object {
        $dossier_utilisateur = $_.FullName
        Get-ChildItem -Path $dossier_utilisateur -Directory | ForEach-Object {
            $dossier_fichier = $_.FullName
            Write-Log "Dossier détecté: $dossier_fichier"

            # Déplacement vers le dossier d'analyse
            $nom_utilisateur = (Get-Item $dossier_utilisateur).Name
            $dossier_temp = "$dossier_analyse\$nom_utilisateur"
            if (!(Test-Path $dossier_temp)) {
                New-Item -Path $dossier_temp -ItemType Directory | Out-Null
            }
            Move-Item -Path $dossier_fichier -Destination $dossier_temp -Force
            Write-Log "Déplacé vers $dossier_temp pour analyse"
            $dossier_fichier = "$dossier_temp\$(Get-Item $dossier_fichier).Name"

            # Analyse avec ClamWin
            $resultat = & "$clamwin_path" --no-summary --infected --database="$database_path" --log="$fichier_log" "$dossier_fichier"

            # Vérification du résultat de l'analyse
            if ($resultat -match "Infected files: 0") {
                # Fichier sain : déplacement vers le dossier de transfert
                $dossier_transfert_utilisateur = "$dossier_transfert\$nom_utilisateur"
                if (!(Test-Path $dossier_transfert_utilisateur)) {
                    New-Item -Path $dossier_transfert_utilisateur -ItemType Directory | Out-Null
                }
                Move-Item -Path $dossier_fichier -Destination $dossier_transfert_utilisateur -Force
                Write-Log "$dossier_fichier | SAIN | transféré"
                Write-Host "Réussite: $dossier_fichier transféré vers $dossier_transfert_utilisateur"
            } else {
                # Fichier infecté : déplacement vers la quarantaine
                $dossier_quarantaine_utilisateur = "$dossier_quarantaine\$nom_utilisateur"
                if (!(Test-Path $dossier_quarantaine_utilisateur)) {
                    New-Item -Path $dossier_quarantaine_utilisateur -ItemType Directory | Out-Null
                }
                Move-Item -Path $dossier_fichier -Destination $dossier_quarantaine_utilisateur -Force
                Write-Log "$dossier_fichier | VIRUS | mis en quarantaine"
                Write-Host "Échec: $dossier_fichier infecté, déplacé en quarantaine."
            }

            Write-Log "Analyse terminée pour $dossier_fichier"
        }
    }
    Start-Sleep -Seconds 10
}

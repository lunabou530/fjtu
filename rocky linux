#!/bin/bash

# Chemins des dossiers
DOSSIER_RECEPTION="/chemin/vers/reception"
DOSSIER_ANALYSE="/chemin/vers/analyse"
DOSSIER_TRANSFER="/chemin/vers/transfer"
DOSSIER_QUARANTAINE="/chemin/vers/quarantine"
FICHIER_LOG="/chemin/vers/logs/logs.txt"

# Fonction pour obtenir la date et l'heure actuelles
obtenir_date_heure() {
    date "+%Y-%m-%d_%H-%M-%S"
}

# Fonction pour écrire dans le fichier de log
ecrire_dans_log() {
    local date_heure=$(obtenir_date_heure)
    local message="$1 | $2 | $3 | $date_heure"
    echo "$message" >> "$FICHIER_LOG"
}

# Fonction pour notifier
notifier() {
    local titre="$1"
    local message="$2"
    if [ -f /usr/bin/notify-send ]; then
        notify-send -u critical "$titre" "$message"
    fi
}

# Fonction pour traiter un fichier
traiter_fichier() {
    local fichier="$1"
    local dossier_utilisateur="$2"

    # Créer un nom de dossier avec la date et l'heure pour l'unicité
    local date_heure_string=$(obtenir_date_heure)
    local chemin_nouveau_dossier="$dossier_utilisateur/$(basename "$fichier" .*)_$date_heure_string"
    mkdir -p "$chemin_nouveau_dossier"

    # Générer le hash et les métadonnées
    local hash_fichier=$(sha256sum "$fichier" | awk '{ print $1 }')
    local nom_utilisateur=$(basename "$dossier_utilisateur")
    echo "$hash_fichier" > "$chemin_nouveau_dossier/hash_fichier.txt"
    echo "$nom_utilisateur" > "$chemin_nouveau_dossier/utilisateur.txt"

    # Déplacer le fichier et lancer l'analyse avec ClamAV
    mv "$fichier" "$chemin_nouveau_dossier"
    clamdscan --fdpass "$chemin_nouveau_dossier" --move="$DOSSIER_QUARANTAINE"

    # Vérifier le résultat de l'analyse
    if [ $? -eq 0 ]; then
        # Fichier sain : Déplacer dans le dossier d'analyse
        local chemin_dossier_analyse="$DOSSIER_ANALYSE/$nom_utilisateur"
        mkdir -p "$chemin_dossier_analyse"
        mv "$chemin_nouveau_dossier" "$chemin_dossier_analyse"

        # Transfert vers le dossier de transfert
        local chemin_dossier_transfert="$DOSSIER_TRANSFER/$nom_utilisateur"
        mkdir -p "$chemin_dossier_transfert"
        mv "$chemin_dossier_analyse" "$chemin_dossier_transfert"
        ecrire_dans_log "$fichier" "sain" "fichier_transfere"

        # Notification de transfert réussi
        notifier "Transfert réussi" "Le fichier $fichier a été transféré vers $chemin_dossier_transfert"
    else
        # Fichier infecté : Log et mise en quarantaine
        ecrire_dans_log "$fichier" "VIRUS" "fichier_quarantaine"

        # Notification d'échec de l'analyse
        notifier "Analyse échouée" "Le fichier $fichier est infecté et a été mis en quarantaine."
    fi

    # Notification de fin d'analyse
    notifier "Analyse terminée" "Analyse terminée pour le fichier $fichier"
}

# Surveiller les fichiers
surveiller_fichiers() {
    while true; do
        inotifywait -q -r -e create,modify,move,delete,open,close,access "$DOSSIER_RECEPTION" --format '%w%f' |
        while read fichier; do
            dossier_utilisateur=$(dirname "$fichier")
            traiter_fichier "$fichier" "$dossier_utilisateur"
        done
    done
}

# Démarrer la surveillance des fichiers
surveiller_fichiers

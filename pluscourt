# D√©finition des chemins
$ClamWinPath = "C:\Program Files (x86)\ClamWin\bin\clamscan.exe"
$DossierReception = "Z:\"
$DossierAnalyse = "C:\analyse"
$DossierTransfer = "C:\projet\disponible"
$FichierLog = "C:\projet\logs\logs.txt"

# Fonction d'√©criture dans le log
function Write-Log {
    param ($Message)
    "$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss")) | $Message" | Out-File -Append -FilePath $FichierLog
}

# V√©rifier si le dossier d'analyse existe, sinon le cr√©er
if (!(Test-Path $DossierAnalyse)) {
    New-Item -Path $DossierAnalyse -ItemType Directory | Out-Null
}

# V√©rifier si le dossier de transfert existe, sinon le cr√©er
if (!(Test-Path $DossierTransfer)) {
    New-Item -Path $DossierTransfer -ItemType Directory | Out-Null
}

# Surveillance continue des fichiers
while ($true) {
    # R√©cup√©rer les dossiers dans DossierReception
    Get-ChildItem -Path $DossierReception -Directory | ForEach-Object {
        $DossierUtilisateur = $_.FullName
        $NomUtilisateur = $_.Name
        $DossierAnalyseUtilisateur = "$DossierAnalyse\$NomUtilisateur"

        # D√©placer le dossier vers le dossier d'analyse
        Move-Item -Path $DossierUtilisateur -Destination $DossierAnalyseUtilisateur -Force
        Write-Host "üìÇ Dossier d√©plac√© vers analyse: $DossierUtilisateur -> $DossierAnalyseUtilisateur"
        Write-Log "Dossier d√©plac√© vers analyse: $DossierUtilisateur -> $DossierAnalyseUtilisateur"

        # Ex√©cuter l'analyse avec ClamWin
        & "$ClamWinPath" --official-db-only "$DossierAnalyseUtilisateur"
        
        # V√©rifier le code de retour pour d√©terminer si un fichier est infect√©
        if ($LASTEXITCODE -eq 0) {
            # Aucun virus d√©tect√©, d√©placement vers le dossier de transfert
            $DossierTransfertUtilisateur = "$DossierTransfer\$NomUtilisateur"
            if (!(Test-Path $DossierTransfertUtilisateur)) {
                New-Item -Path $DossierTransfertUtilisateur -ItemType Directory | Out-Null
            }
            Move-Item -Path $DossierAnalyseUtilisateur -Destination $DossierTransfertUtilisateur -Force
            Write-Host "‚úÖ Dossier sain d√©plac√© vers: $DossierTransfertUtilisateur"
            Write-Log "‚úÖ Dossier sain d√©plac√© vers: $DossierTransfertUtilisateur"
        } else {
            # Virus d√©tect√©, le dossier reste dans analyse
            Write-Host "‚ùå Dossier infect√© d√©tect√©, il reste dans: $DossierAnalyseUtilisateur"
            Write-Log "‚ùå Dossier infect√© d√©tect√©, il reste dans: $DossierAnalyseUtilisateur"
        }
    }
    # Attendre 10 secondes avant de v√©rifier √† nouveau
    Start-Sleep -Seconds 10
}

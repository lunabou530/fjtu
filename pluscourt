# Chemins des dossiers
$dossier_reception = "Z:\"
$dossier_analyse = "C:\projet\analyse"
$dossier_transfert = "C:\projet\disponible"
$fichier_log = "C:\projet\logs\logs.txt"

# Chemin vers l'exécutable ClamWin
$clamScanPath = "C:\Program Files\ClamWin\bin\clamscan.exe"

# Surveiller les fichiers
while ($true) {
    # Parcourir les sous-dossiers utilisateur dans le dossier de réception
    Get-ChildItem -Path $dossier_reception -Directory | ForEach-Object {
        $dossier_utilisateur = $_

        # Parcourir les sous-dossiers contenant les fichiers
        Get-ChildItem -Path $dossier_utilisateur.FullName -Directory | ForEach-Object {
            $dossier_fichier = $_

            # Log de détection de dossier
            $dateHeure = (Get-Date).ToString("yyyy-MM-dd_HH-mm-ss")
            "$dossier_fichier | detecte | dossier_detecte | $dateHeure" | Out-File -Append $fichier_log
            Write-Output "Analysant le dossier: $dossier_fichier"

            # Lancer l'analyse avec ClamWin
            & $clamScanPath --verbose --recursive --log=$fichier_log $dossier_fichier

            # Vérification du code de retour de l'analyse
            $exitCode = $LASTEXITCODE
            Write-Output "Code de retour de l'analyse: $exitCode"

            # Logique if else en fonction du code de retour
            if ($exitCode -eq 0) {
                # Fichier sain : Déplacer dans le dossier de transfert
                $nom_utilisateur = Split-Path $dossier_utilisateur -Leaf
                $chemin_dossier_transfert = Join-Path $dossier_transfert $nom_utilisateur
                if (-not (Test-Path $chemin_dossier_transfert)) {
                    New-Item -Path $chemin_dossier_transfert -ItemType Directory
                }
                Write-Output "Déplaçant $dossier_fichier vers $chemin_dossier_transfert"
                Move-Item -Path $dossier_fichier -Destination $chemin_dossier_transfert
                "$dossier_fichier | sain | fichier_transfere | $dateHeure" | Out-File -Append $fichier_log
                Write-Output "Réussite: $dossier_fichier a été transféré vers $chemin_dossier_transfert"
            } elseif ($exitCode -eq 1) {
                # Fichier infecté : Log et suppression
                "$dossier_fichier | VIRUS | fichier_supprime | $dateHeure" | Out-File -Append $fichier_log
                Write-Output "Supprimant le dossier infecté: $dossier_fichier"
                Remove-Item -Path $dossier_fichier -Recurse -Force
                Write-Output "Échec: Le dossier $dossier_fichier est infecté et a été supprimé."
            } elseif ($exitCode -eq 2) {
                Write-Output "Erreur: Une erreur est survenue pendant l'analyse de $dossier_fichier."
            } else {
                Write-Output "Code de retour inconnu : $exitCode pour $dossier_fichier"
            }

            # Notification de fin d'analyse
            Write-Output "Analyse terminée pour le dossier $dossier_fichier"
        }
    }
    Start-Sleep -Seconds 10
}

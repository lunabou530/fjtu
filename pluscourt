# D√©finition des chemins
$ClamWinPath = "C:\Program Files (x86)\ClamWin\bin\clamscan.exe"
$ClamDBPath = "C:\Program Files (x86)\ClamWin\db"  # Emplacement de la base de donn√©es
$DossierReception = "Z:\"  # Dossier r√©seau mont√©
$DossierAnalyse = "C:\analyse"
$DossierTransfer = "C:\projet\disponible"
$FichierLog = "C:\projet\logs\logs.txt"

# Fonction d'√©criture dans le log
function Write-Log {
    param ($Message)
    "$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss")) | $Message" | Out-File -Append -FilePath $FichierLog
}

# V√©rification initiale du lecteur r√©seau
if (!(Test-Path $DossierReception)) {
    Write-Log "‚ùå Le lecteur r√©seau $DossierReception est inaccessible."
    Write-Host "Le lecteur r√©seau $DossierReception est inaccessible. V√©rifiez la connexion."
    exit
}

Write-Log "‚úÖ Le lecteur r√©seau $DossierReception est accessible."

# V√©rification et mise √† jour de la base ClamAV
if (!(Test-Path $ClamDBPath)) {
    Write-Log "‚ö†Ô∏è Base ClamAV non trouv√©e: $ClamDBPath"
    Write-Host "‚ö†Ô∏è Base ClamAV non trouv√©e: $ClamDBPath. V√©rifiez l'installation de ClamWin."
    exit
}

Write-Log "üîÑ Mise √† jour de la base ClamAV..."
& "C:\Program Files (x86)\ClamWin\bin\freshclam.exe" | Out-Null
Write-Log "‚úÖ Mise √† jour de ClamAV termin√©e."

# Boucle infinie pour surveiller les fichiers en continu
while ($true) {
    Get-ChildItem -Path $DossierReception -Directory | ForEach-Object {
        $DossierUtilisateur = $_.FullName
        $NomUtilisateur = $_.Name

        if (Test-Path $DossierUtilisateur) {
            Write-Log "üìÇ Dossier d√©tect√©: $DossierUtilisateur"

            $DossierAnalyseUtilisateur = "$DossierAnalyse\$NomUtilisateur"
            if (!(Test-Path $DossierAnalyseUtilisateur)) {
                New-Item -Path $DossierAnalyseUtilisateur -ItemType Directory | Out-Null
            }

            Write-Log "üîÑ D√©placement vers analyse: $DossierUtilisateur -> $DossierAnalyseUtilisateur"
            Move-Item -Path $DossierUtilisateur -Destination $DossierAnalyseUtilisateur -Force

            # Ex√©cution de l'analyse ClamWin
            Write-Log "üïµÔ∏è D√©but de l'analyse ClamWin: $DossierAnalyseUtilisateur"
            $Resultat = & "$ClamWinPath" --no-summary --infected "$DossierAnalyseUtilisateur" 2>&1
            $AnalyseOK = $Resultat -match "Infected files:"

            if (!$AnalyseOK) {
                Write-Log "‚ùå Erreur ClamWin, l'analyse ne s'est pas faite correctement."
                Write-Host "‚ö†Ô∏è Erreur ClamWin, l'analyse a √©chou√© pour: $DossierAnalyseUtilisateur"
                continue  # Passe au fichier suivant
            }

            if ($Resultat -match "Infected files: 0") {
                # Fichier sain : d√©placement vers dossier de transfert
                $DossierTransfertUtilisateur = "$DossierTransfer\$NomUtilisateur"
                if (!(Test-Path $DossierTransfertUtilisateur)) {
                    New-Item -Path $DossierTransfertUtilisateur -ItemType Directory | Out-Null
                }

                Write-Log "‚úÖ Dossier sain, d√©placement vers transfert: $DossierAnalyseUtilisateur -> $DossierTransfertUtilisateur"
                Move-Item -Path $DossierAnalyseUtilisateur -Destination $DossierTransfertUtilisateur -Force
            } else {
                Write-Log "‚ùå Dossier infect√©, non transf√©r√©: $DossierAnalyseUtilisateur"
            }
        }
    }
    Start-Sleep -Seconds 10
}
